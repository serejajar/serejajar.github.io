<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>VK photos</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- libs -->
    <script src="../libs/react16.min.js" defer></script>
    <script src="../libs/react16-dom.min.js" defer></script>
    <script src="../libs/redux-4.0.4.js" defer></script>
    <script src="../libs/openapi-162.js"></script>
    <!-- Enable JSX (not for production)-->
    <script src="../libs/babel-6.26.min.js" defer></script>
    <script src="../libs/react-redux-7.1.3.js" defer></script>
    <script src="../libs/redux-thunk-2.3.0.js" defer></script>

    <!-- React and Redux components -->
    <!-- <script src="./components/User.js" type="text/babel" defer></script> -->
    <script type="text/babel" defer>

// USer.js
class User extends React.Component {
  renderTemplate = () => {
    const { name, error, isFetching } = this.props

    if (error) {
      return <p>Error while log in: {error}</p>
    }

    if (isFetching) {
      return <p>Please wait...</p>
    }

    if (name) {
      return <p>Hi, {name}!</p>
    } else {
      return (
        <button className="btn" onClick={this.props.handleLogin}>
          Log in
        </button>
      )
    }
  }
  render() {
    console.log('User');
    return <div className="ib user">{this.renderTemplate()}</div>
  }
}


// UserContainer
class UserContainer extends React.Component {
  render() {
    console.log('UserContainer');
    const { user, handleLogin } = this.props
    return (
      <User
        name={user.name}
        error={user.error}
        isFetching={user.isFetching}
        handleLogin={handleLogin}
      />
    )
  }
}

const userMapStateToProps = store => {
  return {
    user: store.user,
  }
}

const userMapDispatchToProps = dispatch => {
  return {
    handleLogin: () => dispatch(handleLogin()),
  }
}

const userConnector = ReactRedux.connect(
  userMapStateToProps,
  userMapDispatchToProps
);
UserContainer = userConnector(UserContainer);


// vk-photos\components\Page.js
class Page extends React.Component {
  onBtnClick = e => {
    const year = +e.currentTarget.innerText
    this.props.getPhotos(year)
  }
  renderButtons = () => {
    let yearNumber = new Date().getFullYear();
    const years = [];
    for (var i = 0; i < 5; i++) {
      years.push(yearNumber - i)
    }


    return years.map((item, index) => {
      const year = yearNumber - index;
      return (
        <button key={year} className="btn" onClick={this.onBtnClick}>
          {year}
        </button>
      )
    })
  }
  renderTemplate = () => {
    const { photos, isFetching, error } = this.props

    if (error) {
      return <p className="error">Error while request photo: {error}</p>
    }

    if (isFetching) {
      return <p>Загрузка...</p>
    } else {
      return photos.map(entry => (
        <div key={entry.id} className="photo">
          <p>
            <img src={entry.sizes[0].url} alt="" />
          </p>
          <p>{entry.likes.count} ❤</p>
        </div>
      ))
    }
  }

  renderHeader = () => {
    const { year, photos } = this.props
    if (year) {
      return `${year} год [${photos.length}]`
    }

    return `Click on a year button to get your photos`;
  }

  render() {
    console.log('Page');
    const { year, photos } = this.props
    return (
      <div className="ib page">
        <p>{this.renderButtons()}</p>
        <h3>
          {this.renderHeader()}
        </h3>
        {this.renderTemplate()}
      </div>
    )
  }
}

// vk-photos\components\PageContainer.js
class PageContainer extends React.Component {
  render() {
    console.log('PageContainer');
    const { page, user, getPhotos } = this.props

    if (!user.name) {
      return null;
    }

    return (
      <Page
        photos={page.photos}
        year={page.year}
        isFetching={page.isFetching}
        error={page.error}
        getPhotos={getPhotos}
      />
    )
  }
}

const pageMapStateToProps = store => {
  return {
    page: store.page,
    user: store.user,
  }
}

const pageMapDispatchToProps = dispatch => {
  return {
    getPhotos: year => dispatch(getPhotos(year)),
  }
}

const pageConnector = ReactRedux.connect(
  pageMapStateToProps,
  pageMapDispatchToProps
);
PageContainer = pageConnector(PageContainer);


// src="src/components/App.js"
class App extends React.Component {
  render() {
    console.log('App');
    return (
      <div className="app">
        <UserContainer />
        <PageContainer />
      </div>
    )
  }
}

// vk-photos\redux\actions\UserActions.js
const LOGIN_REQUEST = 'LOGIN_REQUEST'
const LOGIN_SUCCESS = 'LOGIN_SUCCESS'
const LOGIN_FAIL = 'LOGIN_FAIL'

function handleLogin() {
  return function(dispatch) {
    dispatch({
      type: LOGIN_REQUEST,
    })

    //eslint-disable-next-line no-undef
    VK.Auth.login(r => {
      console.log('VK.Auth.login', r);
      if (r.session) {
        let username = r.session.user.first_name

        dispatch({
          type: LOGIN_SUCCESS,
          payload: username,
        })
      } else {
        dispatch({
          type: LOGIN_FAIL,
          error: true,
          payload: new Error('Autorization error'),
        })
      }
    }, 4)
  }
}

// vk-photos\redux\actions\PageActions.js
const GET_PHOTOS_REQUEST = 'GET_PHOTOS_REQUEST'
const GET_PHOTOS_SUCCESS = 'GET_PHOTOS_SUCCESS'
const GET_PHOTOS_FAIL = 'GET_PHOTOS_FAIL'

let photosArr = []
let cached = false

function makeYearPhotos(photos, selectedYear) {
  let createdYear,
    yearPhotos = []

  photos.forEach(item => {
    createdYear = new Date(item.date * 1000).getFullYear()
    if (createdYear === selectedYear) {
      yearPhotos.push(item)
    }
  })

  yearPhotos.sort((a, b) => b.likes.count - a.likes.count)

  return yearPhotos
}

function getMorePhotos(offset, count, year, dispatch) {
  //eslint-disable-next-line no-undef
  VK.Api.call(
    'photos.getAll',
    { extended: 1, count: count, offset: offset, v: '5.80' },
    r => {
      try {
        photosArr = photosArr.concat(r.response.items)
        if (offset <= r.response.count) {
          offset += 200
          getMorePhotos(offset, count, year, dispatch)
        } else {
          let photos = makeYearPhotos(photosArr, year)
          cached = true
          dispatch({
            type: GET_PHOTOS_SUCCESS,
            payload: photos,
          })
        }
      } catch (e) {
        dispatch({
          type: GET_PHOTOS_FAIL,
          error: true,
          payload: new Error(e),
        })
      }
    }
  )
}

function getPhotos(year) {
  return dispatch => {
    dispatch({
      type: GET_PHOTOS_REQUEST,
      payload: year,
    })

    if (cached) {
      let photos = makeYearPhotos(photosArr, year)
      dispatch({
        type: GET_PHOTOS_SUCCESS,
        payload: photos,
      })
    } else {
      getMorePhotos(0, 200, year, dispatch)
    }
  }
}


// vk-photos\redux\reducers\user.js
const initialState1 = {
  name: '',
  error: '',
  isFetching: false,
}

function userReducer(state = initialState1, action) {
  switch (action.type) {
    case LOGIN_REQUEST:
      return { ...state, isFetching: true, error: '' }

    case LOGIN_SUCCESS:
      return { ...state, isFetching: false, name: action.payload }

    case LOGIN_FAIL:
      return { ...state, isFetching: false, error: action.payload.message }

    default:
      return state
  }
}


// vk-photos\redux\reducers\page.js
const initialState2 = {
  year: 0,
  photos: [],
  isFetching: false,
  error: '',
}

function pageReducer(state = initialState2, action) {
  switch (action.type) {
    case GET_PHOTOS_REQUEST:
      return { ...state, year: action.payload, isFetching: true, error: '' }

    case GET_PHOTOS_SUCCESS:
      return { ...state, photos: action.payload, isFetching: false, error: '' }

    case GET_PHOTOS_FAIL:
      return { ...state, error: action.payload.message, isFetching: false }

    default:
      return state
  }
}


// vk-photos\redux\reducers\index.js
const rootReducer = Redux.combineReducers({
  page: pageReducer,
  user: userReducer,
})

// vk-photos\redux\store\configureStore.js
const store = Redux.createStore(rootReducer, Redux.applyMiddleware(ReduxThunk.default))

// index.js
const { Provider } = ReactRedux;

ReactDOM.render(
  <Provider store={store}>
    <App />
  </Provider>,
  document.getElementById('root')
);



    </script>
  </head>
  <body>
    <script language="javascript">
      VK.init({
        apiId: 7217333
      });
    </script>
    <div id="root"></div>
  </body>
</html>
